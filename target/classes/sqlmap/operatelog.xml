<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="operateLog">

	<!-- 文章表SQL -->
	<!--2012-05-21-->
   	<typeAlias alias="OperateLog" type="com.taobao.freeproj.domain.OperateLog"/>

  	<insert id="insert"  parameterClass="OperateLog">
		<!--插入主表-->
		INSERT INTO common_operate_log
		(`userId`,`userName`,`createTime`,`content`,`result`,`operationCode`,`system`,`ip`,`title`,`targetKey`,`revision`)
		VALUES
		(#userId#, #userName#, now(), #content#, #result#, #operationCode#, #system#, #ip#, #title#,#targetKey#, #revision#);
		<selectKey keyProperty="id" type="post" resultClass="int">
      		select LAST_INSERT_ID() as value
    	</selectKey>
	</insert>
		
	<!--2012-10-17 by liusan.dyf 增加startTime、endTime
	2014-11-12增加strictOperationCode by 六三
	select * from common_operate_log where operationCode = 'script.after-update' and targetKey = '5967' order by id desc limit 1;

	-->
	<sql id="selectClause">
		<dynamic>
			<isNotEmpty property="id">
				and `id` = #id#
			</isNotEmpty>
			
			<isNotEmpty property="operationCode">
				and `operationCode` like CONCAT(#operationCode#,'%')
			</isNotEmpty>

			<isNotEmpty property="strictOperationCode">
				and `operationCode` = #strictOperationCode#
			</isNotEmpty>

			<isNotEmpty property="targetKey">
				and `targetKey` = #targetKey#
			</isNotEmpty>
			<isNotEmpty property="userName">
				and `userName` = #userName#
			</isNotEmpty>

			<isNotEmpty property="revision">
				and `revision` = #revision#
			</isNotEmpty>
			
			<isNotEmpty property="startTime">
				and `createTime` >= #startTime#
			</isNotEmpty>
			
			<isNotEmpty property="endTime">
				and `createTime` &lt;= #endTime#
			</isNotEmpty>
			
			<isNotNull property="idList">
				and id in 
		    	<iterate property="idList" open="(" close=")" conjunction=",">   
					#idList[]#   
				</iterate> 
			</isNotNull>
			
		</dynamic>
	</sql>

	<select id="getPagedList" resultClass="OperateLog" parameterClass="hashmap">
		SELECT `id`,`userId`,`userName`,`createTime`,
		<dynamic>
			<isNotEmpty property="noContent">
				null as 
			</isNotEmpty>
		</dynamic>
		`content`,		
		`result`,`operationCode`,`system`,`ip`,`title`,`targetKey`,`revision`
		FROM `common_operate_log` where 1 = 1
		<include refid="selectClause"/>
		order by `id` desc
		limit #skip#,#limit#;
	</select>
	
	<select id="getCount" resultClass="int" parameterClass="hashmap">
		SELECT count(0) FROM `common_operate_log` where 1 = 1
		<include refid="selectClause"/>
		;
	</select>
</sqlMap>